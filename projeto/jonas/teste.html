<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sitemap Explorer (Offline)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:#f7fafc;color:#1f2937}
  .container{max-width:1100px;margin:0 auto;padding:48px 24px}
  .h1{font-size:28px;font-weight:800;margin:0 0 6px}
  .bar{width:80px;height:4px;background:#3b82f6;border-radius:99px;margin:0 auto 8px}
  .muted{color:#6b7280;font-size:13px;text-align:center;margin-top:8px}

  /* picker */
  .picker{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:20px 0}
  .btn{padding:.55rem .85rem;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;font-size:.9rem}
  .btn:hover{background:#f9fafb}
  .btn-dark{background:#111827;color:#fff;border-color:#111827}
  .btn-dark:hover{filter:brightness(1.05)}
  .input{padding:.5rem .75rem;border:1px solid #e5e7eb;border-radius:10px;font-size:.9rem}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .chip{padding:.4rem .7rem;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:.85rem;cursor:pointer}
  .chip--active{border-color:#3b82f6;background:#eff6ff;color:#1d4ed8}

  /* dropzone */
  .drop{border:2px dashed #cbd5e1;border-radius:14px;background:#fff;padding:18px;text-align:center;color:#475569}
  .drop.drag{background:#f0f9ff;border-color:#38bdf8}
  .drop small{display:block;color:#64748b}

  /* list */
  .status{font-size:13px;color:#6b7280;margin:10px 0}
  .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.04);padding:10px}
  .list{max-height:560px;overflow:auto}
  .row{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;border-bottom:1px solid #f1f5f9}
  .url{color:#2563eb;text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .url:hover{text-decoration:underline}
  .meta{font-size:12px;color:#6b7280;white-space:nowrap}

  details.acc{border:1px solid #eef2f7;border-radius:10px;margin:8px 0;background:#fff}
  details.acc>summary{list-style:none;padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:700}
  details.acc[open]>summary{background:#f9fafb}
  .badge{font-size:11px;background:#e5e7eb;color:#1f2937;border-radius:999px;padding:2px 8px;margin-left:auto}

  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grow{margin-left:auto}
</style>
</head>
<body>
<section class="container">
  <h1 class="h1" style="text-align:center">Mapa do Site (Offline)</h1>
  <div class="bar"></div>
  <p class="muted">Arraste a pasta com os XMLs ou use os botões abaixo. Nenhuma requisição de rede — tudo roda local.</p>

  <!-- PICKERS -->
  <div class="picker">
    <button id="pickDir" class="btn">Escolher pasta</button>
    <button id="pickFiles" class="btn">Escolher arquivos XML</button>
    <div class="grow controls">
      <input id="search" class="input" type="search" placeholder="Buscar página…">
      <select id="group" class="input">
        <option value="flat">Listar simples</option>
        <option value="dir">Agrupar por diretório</option>
      </select>
      <button id="copy" class="btn btn-dark">Copiar links</button>
    </div>
  </div>

  <div id="drop" class="drop">
    <strong>Arraste aqui</strong>
    <small>Arquivos *.xml (inclua <code>sitemap.xml</code> se quiser usar o índice)</small>
  </div>

  <!-- chips -->
  <div id="chips" class="chips"></div>

  <div id="status" class="status">Nenhum arquivo carregado.</div>

  <div class="card">
    <div id="list" class="list"><div class="muted" style="text-align:left;padding:12px">Carregue seus XMLs para listar.</div></div>
  </div>
</section>

<!-- inputs invisíveis -->
<input id="inputDir" type="file" webkitdirectory multiple accept=".xml" style="display:none">
<input id="inputFiles" type="file" multiple accept=".xml" style="display:none">

<script>
(() => {
  // estado
  const fileMap = new Map();       // basename -> File
  const cache   = { todos: [] };   // key -> [{loc,lastmod}]
  const titles  = {};              // key -> label
  let currentKey = 'todos';

  // elementos
  const $chips = document.getElementById('chips');
  const $status= document.getElementById('status');
  const $list  = document.getElementById('list');
  const $search= document.getElementById('search');
  const $group = document.getElementById('group');
  const $copy  = document.getElementById('copy');
  const $drop  = document.getElementById('drop');

  // helpers
  const titleCase = s => s.replace(/[-_]+/g,' ').replace(/\s+/g,' ').trim().replace(/\b\w/g,m=>m.toUpperCase());
  const fmtDate = iso => { if(!iso) return ''; const d=new Date(iso); return isNaN(d)?iso:d.toLocaleDateString('pt-BR',{year:'numeric',month:'short',day:'2-digit'}); };
  const fileKeyFromBasename = b => (b.replace(/\.xml$/,'').replace(/^sitemap-?/,'') || 'geral');
  const labelFromKey = k => titles[k] || (titles[k]=titleCase(k));
  const firstDir = loc => { try{const p=new URL(loc).pathname.replace(/^\/+/,''); return (p.split('/')[0]||'').toLowerCase(); }catch{return '';} };

  function readFile(file){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res(fr.result);
      fr.onerror=()=>rej(fr.error||new Error('Falha ao ler arquivo'));
      fr.readAsText(file);
    });
  }
  function parseXml(text){
    const doc = new DOMParser().parseFromString(text,'application/xml');
    if (doc.querySelector('parsererror')) throw new Error('XML inválido');
    return doc;
  }
  function parseUrlset(doc){
    return [...doc.querySelectorAll('urlset > url')].map(u=>({
      loc: u.querySelector('loc')?.textContent?.trim(),
      lastmod: u.querySelector('lastmod')?.textContent?.trim() || ''
    })).filter(u=>u.loc);
  }
  function parseIndex(doc){
    return [...doc.querySelectorAll('sitemapindex > sitemap > loc')].map(n=>n.textContent.trim());
  }

  function buildChips(keys){
    $chips.innerHTML = '';
    keys.forEach((k,i)=>{
      const b=document.createElement('button');
      b.className='chip'+(i===0?' chip--active':'');
      b.dataset.key=k;
      b.textContent = (k==='todos'?'Todos':labelFromKey(k));
      b.onclick=()=>{ currentKey=k; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('chip--active')); b.classList.add('chip--active'); render(); };
      $chips.appendChild(b);
    });
  }

  function dedupe(arr){
    const seen=new Set(); return arr.filter(o=>!seen.has(o.loc) && seen.add(o.loc));
  }

  async function processFiles(files){
    // montar fileMap
    fileMap.clear();
    [...files].forEach(f=>{
      if(!/\.xml$/i.test(f.name)) return;
      fileMap.set(f.name, f); // usa basename (ex: sitemap-curitiba.xml)
    });
    if (fileMap.size===0){
      $status.textContent='Nenhum XML encontrado.';
      $list.innerHTML='<div class="muted" style="padding:12px">Adicione arquivos .xml.</div>';
      return;
    }

    // limpar cache
    Object.keys(cache).forEach(k=>delete cache[k]);
    cache.todos=[];

    // Se houver sitemap.xml (índice), seguir os filhos que estiverem selecionados.
    const hadIndex = fileMap.has('sitemap.xml');
    let keysInOrder = ['todos'];
    if (hadIndex){
      $status.textContent='Lendo índice (sitemap.xml)…';
      try{
        const idxDoc = parseXml(await readFile(fileMap.get('sitemap.xml')));
        const children = parseIndex(idxDoc); // urls absolutas
        const all = [];
        for (const loc of children){
          const base = loc.split('/').pop();         // ex: sitemap-curitiba.xml
          const key  = fileKeyFromBasename(base);    // curitiba
          keysInOrder.push(key);
          if (!fileMap.has(base)){                   // arquivo não foi selecionado
            cache[key]=[];
            continue;
          }
          const doc = parseXml(await readFile(fileMap.get(base)));
          const urls = parseUrlset(doc);
          cache[key]=urls;
          all.push(...urls);
        }
        cache.todos = dedupe(all);
      }catch(e){
        console.error(e);
        $status.textContent='Erro ao ler o índice. Lendo arquivos individuais…';
        await processIndividually(keysInOrder);
      }
    }else{
      await processIndividually(keysInOrder);
    }

    buildChips([...new Set(keysInOrder)]);
    currentKey='todos';
    render();
  }

  async function processIndividually(keysInOrder){
    const all=[];
    for (const [name,file] of fileMap.entries()){
      const key = fileKeyFromBasename(name);
      keysInOrder.push(key);
      try{
        const doc=parseXml(await readFile(file));
        const urls=parseUrlset(doc);
        cache[key]=urls;
        all.push(...urls);
      }catch(e){
        console.warn('Falha lendo', name, e);
        cache[key]=[];
      }
    }
    cache.todos = dedupe(all);
  }

  function render(){
    const q = $search.value.trim().toLowerCase();
    const mode = $group.value;
    const data = (cache[currentKey]||[]).filter(u=>!q || u.loc.toLowerCase().includes(q));

    $status.textContent = `${data.length} página(s) • origem: ${currentKey==='todos'?'todos os sitemaps':labelFromKey(currentKey)}`;

    if (!data.length){
      $list.innerHTML='<div class="muted" style="padding:12px">Nenhum resultado.</div>';
      return;
    }

    if (mode==='flat'){
      $list.innerHTML = data.sort((a,b)=>a.loc.localeCompare(b.loc)).map(u=>`
        <div class="row">
          <a class="url" href="${u.loc}" target="_blank" rel="noopener">${u.loc}</a>
          <span class="meta">${u.lastmod?fmtDate(u.lastmod):''}</span>
        </div>
      `).join('');
      return;
    }

    // agrupar por primeiro diretório da URL
    const groups={};
    for (const u of data){ const d=firstDir(u.loc)||'(raiz)'; (groups[d]??=[]).push(u); }
    const ordered=Object.entries(groups).sort((a,b)=>a[0].localeCompare(b[0]));
    $list.innerHTML = ordered.map(([dir,arr],i)=>`
      <details class="acc"${i===0?' open':''}>
        <summary>
          <span style="display:inline-flex;align-items:center;gap:.4rem">
            <span style="width:10px;height:10px;background:#3b82f6;border-radius:999px;display:inline-block"></span>
            ${dir==='(raiz)'?'Raiz':titleCase(dir)}
          </span>
          <span class="badge">${arr.length}</span>
        </summary>
        <div>
          ${arr.sort((a,b)=>a.loc.localeCompare(b.loc)).map(u=>`
            <div class="row">
              <a class="url" href="${u.loc}" target="_blank" rel="noopener">
                ${decodeURIComponent(u.loc.split('/').pop()||u.loc).replace(/[-_]/g,' ')}
              </a>
              <span class="meta">${u.lastmod?fmtDate(u.lastmod):''}</span>
            </div>
          `).join('')}
        </div>
      </details>
    `).join('');
  }

  // eventos
  document.getElementById('pickDir').onclick = ()=> document.getElementById('inputDir').click();
  document.getElementById('pickFiles').onclick= ()=> document.getElementById('inputFiles').click();
  document.getElementById('inputDir').addEventListener('change', e=> processFiles(e.target.files));
  document.getElementById('inputFiles').addEventListener('change', e=> processFiles(e.target.files));

  // drag & drop
  ['dragenter','dragover'].forEach(ev=>{
    $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add('drag'); });
  });
  ['dragleave','drop'].forEach(ev=>{
    $drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove('drag'); });
  });
  $drop.addEventListener('drop', e=>{
    const items = e.dataTransfer.items;
    if (items && items[0] && items[0].webkitGetAsEntry){
      // tentar ler diretório (Chrome/Edge/Brave)
      const promises=[];
      for (const item of items){
        const entry=item.webkitGetAsEntry();
        promises.push(readEntry(entry));
      }
      Promise.all(promises).then(files=>{
        const flat = files.flat().filter(f=>/\.xml$/i.test(f.name));
        processFiles(flat);
      });
    }else{
      processFiles(e.dataTransfer.files);
    }
  });

  // Lê diretório recursivamente (Chrome-based)
  function readEntry(entry){
    return new Promise(resolve=>{
      if (entry.isFile){
        entry.file(file=> resolve([file]));
      }else if (entry.isDirectory){
        const dirReader = entry.createReader();
        const out=[];
        const readBatch = ()=> dirReader.readEntries(entries=>{
          if (!entries.length) return resolve(out);
          Promise.all(entries.map(readEntry)).then(chunks=>{
            chunks.forEach(c=> out.push(...c));
            readBatch();
          });
        });
        readBatch();
      }else{
        resolve([]);
      }
    });
  }

  $search.addEventListener('input', render);
  $group.addEventListener('change', render);
  $copy.addEventListener('click', ()=>{
    const links = [...document.querySelectorAll('#list .url')].map(a=>a.href).join('\n');
    if(!links) return;
    navigator.clipboard.writeText(links).then(()=>{
      $copy.textContent='Copiado!';
      setTimeout(()=> $copy.textContent='Copiar links',1000);
    });
  });
})();
</script>
</body>
</html>
